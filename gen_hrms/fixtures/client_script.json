[
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Intern Offer",
  "enabled": 1,
  "modified": "2025-09-12 12:43:04.597837",
  "module": "Gen Hrms",
  "name": "Intern Offer Functionality",
  "script": "// Client Script for Offer Letter DocType\n// Add this in: Setup > Client Script\n\nfrappe.ui.form.on('Offer Letter', {\n    refresh: function(frm) {\n        // Add custom buttons in the toolbar\n        if (!frm.doc.__islocal && frm.doc.offer_status !== 'Draft') {\n            frm.add_custom_button(__('Generate PDF'), function() {\n                generate_pdf(frm);\n            }, __('Actions'));\n            \n            frm.add_custom_button(__('Send Email'), function() {\n                send_offer_email(frm);\n            }, __('Actions'));\n        }\n        \n        // Add button to fetch intern details\n        if (frm.doc.intern_application && !frm.doc.intern_name) {\n            frm.add_custom_button(__('Fetch Intern Details'), function() {\n                fetch_intern_details(frm);\n            });\n        }\n    },\n    \n    // Handle the \"Get Intern Details\" button click\n    get_intern_details: function(frm) {\n        fetch_intern_details(frm);\n    },\n    \n    // Handle the \"Generate PDF\" button click  \n    generate_pdf: function(frm) {\n        generate_pdf(frm);\n    },\n    \n    // Handle the \"Send Email\" button click\n    send_email: function(frm) {\n        send_offer_email(frm);\n    },\n    \n    // Auto-fetch details when intern application is selected\n    intern_application: function(frm) {\n        if (frm.doc.intern_application && !frm.doc.intern_name) {\n            frappe.confirm(\n                __('Do you want to fetch intern details from the selected application?'),\n                function() {\n                    fetch_intern_details(frm);\n                }\n            );\n        }\n    },\n    \n    // Calculate duration when dates change\n    start_date: function(frm) {\n        calculate_duration(frm);\n    },\n    \n    end_date: function(frm) {\n        calculate_duration(frm);\n    },\n    \n    // Show/hide stipend field based on paid internship checkbox\n    is_paid_internship: function(frm) {\n        frm.toggle_display('stipend_amount', frm.doc.is_paid_internship);\n        frm.toggle_reqd('stipend_amount', frm.doc.is_paid_internship);\n    }\n});\n\n// Function to generate PDF\nfunction generate_pdf(frm) {\n    if (frm.doc.__islocal) {\n        frappe.msgprint(__('Please save the document first'));\n        return;\n    }\n    \n    frappe.show_alert({\n        message: __('Generating PDF...'),\n        indicator: 'blue'\n    });\n    \n    frappe.call({\n        method: 'generate_offer_pdf',\n        args: {\n            offer_letter_name: frm.doc.name\n        },\n        callback: function(r) {\n            if (r.message) {\n                frm.reload_doc();\n                if (r.message.file_url) {\n                    window.open(r.message.file_url, '_blank');\n                }\n            }\n        },\n        error: function(r) {\n            frappe.show_alert({\n                message: __('Error generating PDF'),\n                indicator: 'red'\n            });\n        }\n    });\n}\n\n// Function to send offer email\nfunction send_offer_email(frm) {\n    if (frm.doc.__islocal) {\n        frappe.msgprint(__('Please save the document first'));\n        return;\n    }\n    \n    if (!frm.doc.intern_email) {\n        frappe.msgprint(__('Intern email is required'));\n        return;\n    }\n    \n    frappe.confirm(\n        __('Are you sure you want to send the offer letter to {0}?', [frm.doc.intern_email]),\n        function() {\n            frappe.show_alert({\n                message: __('Sending email...'),\n                indicator: 'blue'\n            });\n            \n            frappe.call({\n                method: 'send_offer_letter_email',\n                args: {\n                    offer_letter_name: frm.doc.name\n                },\n                callback: function(r) {\n                    if (r.message) {\n                        frm.reload_doc();\n                    }\n                },\n                error: function(r) {\n                    frappe.show_alert({\n                        message: __('Error sending email'),\n                        indicator: 'red'\n                    });\n                }\n            });\n        }\n    );\n}\n\n// Function to fetch intern details\nfunction fetch_intern_details(frm) {\n    if (!frm.doc.intern_application) {\n        frappe.msgprint(__('Please select an Intern Application first'));\n        return;\n    }\n    \n    frappe.show_alert({\n        message: __('Fetching intern details...'),\n        indicator: 'blue'\n    });\n    \n    frappe.call({\n        method: 'fetch_intern_details',\n        args: {\n            offer_letter_name: frm.doc.name\n        },\n        callback: function(r) {\n            if (r.message) {\n                frm.reload_doc();\n            }\n        },\n        error: function(r) {\n            frappe.show_alert({\n                message: __('Error fetching details'),\n                indicator: 'red'\n            });\n        }\n    });\n}\n\n// Function to calculate duration between dates\nfunction calculate_duration(frm) {\n    if (frm.doc.start_date && frm.doc.end_date) {\n        let start = frappe.datetime.str_to_obj(frm.doc.start_date);\n        let end = frappe.datetime.str_to_obj(frm.doc.end_date);\n        \n        if (end > start) {\n            let months = frappe.datetime.get_diff(end, start) / 30;\n            frm.set_value('duration_months', Math.round(months));\n        }\n    }\n}\n\n// Auto-set position title based on department\nfrappe.ui.form.on('Offer Letter', {\n    department: function(frm) {\n        if (frm.doc.department && !frm.doc.position_title) {\n            let title_map = {\n                'Software Development': 'Software Development Intern',\n                'Web Development': 'Web Development Intern', \n                'Mobile App Development': 'Mobile App Development Intern',\n                'Data Science': 'Data Science Intern',\n                'UI/UX Design': 'UI/UX Design Intern',\n                'Digital Marketing': 'Digital Marketing Intern',\n                'Human Resources': 'HR Intern',\n                'Finance': 'Finance Intern',\n                'Operations': 'Operations Intern'\n            };\n            \n            frm.set_value('position_title', title_map[frm.doc.department] || 'Intern');\n        }\n    }\n});",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Job Offer",
  "enabled": 1,
  "modified": "2025-09-15 16:13:54.661707",
  "module": "Gen Hrms",
  "name": "Data to Job Offer Terms Table",
  "script": "// Client script for Job Offer Doctype\n// This script auto-populates the Offer Terms based on custom field values\n\nfrappe.ui.form.on('Job Offer', {\n    refresh: function(frm) {\n        console.log('Job Offer form refreshed');\n        // Set up field change events for all relevant custom fields\n        \n\n            setup_field_events(frm);\n        \n        // Also update terms when form refreshes\n                setTimeout(() => update_offer_terms(frm), 1000);\n\n    \n    },\n    \n    after_load: function(frm) {\n        console.log('Job Offer form loaded');\n        // Update terms when form loads with existing data\n        setTimeout(() => update_offer_terms(frm), 1000);\n    },\n    \n    // Handle template selection\n    job_offer_term_template: function(frm) {\n        console.log('Job Offer Term Template selected:', frm.doc.job_offer_term_template);\n        // Update terms after a delay to allow template to load\n        setTimeout(() => update_offer_terms(frm), 1500);\n    },\n    \n    // Handle date changes to calculate period\n    custom_start_date: function(frm) {\n        calculate_period(frm);\n        update_offer_terms(frm);\n    },\n    \n    custom_end_date: function(frm) {\n        calculate_period(frm);\n        update_offer_terms(frm);\n    },\n    \n    // Handle stipend amount change specifically - CORRECTED FIELD NAME\n    custom_salary__stipend: function(frm) {\n        console.log('Stipend amount changed:', frm.doc.custom_salary__stipend);\n        update_offer_terms(frm);\n    },\n    \n    // Add this to handle when the child table is populated\n    offer_terms_add: function(frm) {\n        console.log('Row added to offer_terms');\n        update_offer_terms(frm);\n    }\n});\n\nfunction setup_field_events(frm) {\n    console.log('Setting up field events');\n    \n    // List of custom fields to monitor for changes - CORRECTED FIELD NAME\n    const custom_fields = [\n        'custom_department',\n        'custom_start_date',\n        'custom_period',\n        'custom_work_location',\n        'custom_salary__stipend', // Corrected: double underscore\n        'custom_supervisor',\n        'custom_end_date',\n        'custom_work_schedule',\n        'designation',\n        'company'\n    ];\n    \n    console.log('Monitoring these fields:', custom_fields);\n    \n    // Attach event listeners to each field\n    custom_fields.forEach(field => {\n        if (frm.fields_dict[field] && frm.fields_dict[field].df) {\n            console.log('Adding event listener for field:', field);\n            frappe.ui.form.on('Job Offer', field, function(frm) {\n                console.log('Field changed:', field, 'Value:', frm.doc[field]);\n                update_offer_terms(frm);\n            });\n        } else {\n            console.log('Field not found:', field);\n        }\n    });\n}\n\nfunction calculate_period(frm) {\n    if (frm.doc.custom_start_date && frm.doc.custom_end_date) {\n        try {\n            const startDate = new Date(frm.doc.custom_start_date);\n            const endDate = new Date(frm.doc.custom_end_date);\n            \n            // Calculate total difference in days (inclusive)\n            const totalDays = Math.floor((endDate - startDate) / (24 * 60 * 60 * 1000)) + 1;\n            \n            // Calculate months accurately\n            let monthsDiff = 0;\n            let tempDate = new Date(startDate);\n            \n            // Add months until we exceed the end date\n            while (tempDate < endDate) {\n                tempDate.setMonth(tempDate.getMonth() + 1);\n                if (tempDate <= endDate) {\n                    monthsDiff++;\n                }\n            }\n            \n            // Calculate remaining days after full months\n            const lastFullMonth = new Date(startDate);\n            lastFullMonth.setMonth(lastFullMonth.getMonth() + monthsDiff);\n            const remainingDays = Math.floor((endDate - lastFullMonth) / (24 * 60 * 60 * 1000));\n            \n            // Calculate weeks\n            const weeksDiff = Math.floor(totalDays / 7);\n            const remainingDaysFromWeeks = totalDays % 7;\n            \n            let periodText = '';\n            \n            if (monthsDiff >= 1) {\n                periodText = `${monthsDiff} month${monthsDiff !== 1 ? 's' : ''}`;\n                if (remainingDays > 0) {\n                    periodText += ` ${remainingDays} day${remainingDays !== 1 ? 's' : ''}`;\n                }\n            } else if (weeksDiff >= 1) {\n                periodText = `${weeksDiff} week${weeksDiff !== 1 ? 's' : ''}`;\n                if (remainingDaysFromWeeks > 0) {\n                    periodText += ` ${remainingDaysFromWeeks} day${remainingDaysFromWeeks !== 1 ? 's' : ''}`;\n                }\n            } else {\n                periodText = `${totalDays} day${totalDays !== 1 ? 's' : ''}`;\n            }\n            \n            // Update the period field\n            frm.set_value('custom_period', periodText.trim());\n            console.log('Period calculated:', periodText.trim());\n            \n        } catch (error) {\n            console.error('Error calculating period:', error);\n        }\n    }\n}\n\nfunction update_offer_terms(frm) {\n    console.log('Updating offer terms');\n    \n    // Only update if a template is selected\n    if (!frm.doc.job_offer_term_template) {\n        console.log('No Job Offer Term Template selected, skipping update');\n        return;\n    }\n    \n    // Get values from custom fields - CORRECTED FIELD NAME\n    const department = frm.doc.custom_department || '[Department Name]';\n    const start_date = frm.doc.custom_start_date ? format_date(frm.doc.custom_start_date) : '[Start Date]';\n    const period = frm.doc.custom_period || '[X] months/weeks';\n    const work_location = frm.doc.custom_work_location || '[Office Address/Remote/Hybrid]';\n    const salary_stipend = frm.doc.custom_salary__stipend ? format_currency(frm.doc.custom_salary__stipend) : '[Amount]'; // Corrected\n    const supervisor = frm.doc.custom_supervisor_name || '[Supervisor Name and Designation]';\n    const end_date = frm.doc.custom_end_date ? format_date(frm.doc.custom_end_date) : '[End Date]';\n    const work_schedule = frm.doc.custom_work_schedule || '[Days and Hours]';\n    const designation = frm.doc.designation || '[Internship Position]';\n    const company = frm.doc.company || '[Company Name]';\n    \n    console.log('Field values:', {\n        department, start_date, period, work_location, \n        salary_stipend, supervisor, end_date, work_schedule, \n        designation, company\n    });\n    \n    // Create simple list format without HTML\n    const internship_details = \n        `• Position: ${designation}\\n` +\n        `• Department: ${department}\\n` +\n        `• Supervisor: ${supervisor}\\n` +\n        `• Duration: ${start_date} to ${end_date} (${period})\\n` +\n        `• Work Schedule: ${work_schedule}\\n` +\n        `• Work Location: ${work_location}`;\n    \n    const stipend_benefits = \n        `• Monthly Stipend: ${salary_stipend} (if applicable)`;\n    \n    console.log('Internship details:', internship_details);\n    console.log('Stipend benefits:', stipend_benefits);\n    \n    // Try to update existing rows first\n    const internship_updated = update_child_table_row_by_term(frm, 'Internship Details', internship_details);\n    const stipend_updated = update_child_table_row_by_term(frm, 'Stipend and Benefits', stipend_benefits);\n    \n    // If rows don't exist yet, add them\n    if (!internship_updated) {\n        console.log('Adding Internship Details row');\n        add_child_table_row(frm, 'Internship Details', internship_details);\n    }\n    \n    if (!stipend_updated) {\n        console.log('Adding Stipend and Benefits row');\n        add_child_table_row(frm, 'Stipend and Benefits', stipend_benefits);\n    }\n    \n    // Refresh the form to see changes\n    frm.refresh_field('offer_terms');\n}\n\nfunction update_child_table_row_by_term(frm, offer_term_value, new_value) {\n    console.log('Looking for offer term:', offer_term_value);\n    \n    // Get the child table\n    const child_table = frm.fields_dict.offer_terms;\n    \n    if (child_table && child_table.grid) {\n        console.log('Child table found: offer_terms');\n        const grid = child_table.grid;\n        \n        // Find the row with the matching offer_term value\n        let target_row = null;\n        let row_index = -1;\n        \n        grid.data.forEach((row, idx) => {\n            if (row.offer_term === offer_term_value) {\n                target_row = row;\n                row_index = idx;\n                console.log('Found matching row at index:', idx, 'Row:', row);\n            }\n        });\n        \n        if (target_row) {\n            console.log('Updating row with value:', new_value);\n            // Update the value/description field\n            frappe.model.set_value(target_row.doctype, target_row.name, 'value', new_value);\n            console.log('Value updated successfully');\n            \n            // Refresh the grid to see changes\n            grid.refresh();\n            return true;\n        } else {\n            console.log('Row not found with offer_term:', offer_term_value);\n            console.log('Available rows:', grid.data.map(r => r && r.offer_term ? r.offer_term : 'undefined'));\n            return false;\n        }\n    } else {\n        console.log('Child table not found: offer_terms');\n        return false;\n    }\n}\n\nfunction add_child_table_row(frm, offer_term_value, value) {\n    console.log('Adding new row for:', offer_term_value);\n    \n    // Get the child table\n    const child_table = frm.fields_dict.offer_terms;\n    \n    if (child_table && child_table.grid) {\n        // Add a new row\n        const new_row = frappe.model.add_child(frm.doc, 'Job Offer Term', 'offer_terms');\n        \n        // Set the values\n        new_row.offer_term = offer_term_value;\n        new_row.value = value;\n        \n        // Refresh the grid\n        child_table.grid.refresh();\n        \n        console.log('Row added successfully');\n        return true;\n    } else {\n        console.log('Child table not found: offer_terms');\n        return false;\n    }\n}\n\nfunction format_date(date_string) {\n    if (!date_string) return '';\n    \n    // Handle Frappe date format (YYYY-MM-DD)\n    const date_parts = date_string.split('-');\n    if (date_parts.length === 3) {\n        const date = new Date(date_parts[0], date_parts[1] - 1, date_parts[2]);\n        return date.toLocaleDateString('en-US', { \n            year: 'numeric', \n            month: 'long', \n            day: 'numeric' \n        });\n    }\n    \n    return date_string;\n}\n\nfunction format_currency(amount) {\n    if (!amount) return '';\n    \n    // Check if amount is already formatted\n    if (typeof amount === 'string' && amount.includes('$')) {\n        return amount;\n    }\n    \n    // Convert to number if it's a string\n    const numericAmount = typeof amount === 'string' ? parseFloat(amount) : amount;\n    \n    return new Intl.NumberFormat('en-US', {\n        style: 'currency',\n        currency: 'INR',\n        minimumFractionDigits: 2\n    }).format(numericAmount);\n}",
  "view": "Form"
 }
]